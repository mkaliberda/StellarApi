## Stellar Private Network microservice

[![Build Status](https://travis-ci.com/mkaliberda/StellarApi.svg?token=6bfZmbby9wfWj9uzzAgb&branch=dev)](https://travis-ci.com/mkaliberda/StellarApi)

**Микросервис для менеджмента баллансов кошельков пользователей финансовой системы DIMO.**

Архитектура сервиса представляет собой дебитно/кредитную систему хранения балансов.
Кредитые балансы отражают денежные обязательства перед клиентами (балансы которыми владеют пользователь), а дебитные - обязательства внешних сервисов перед владельцами системы или собственных активов владельцев системы.
При этом существует такое понятие как **резервный фонд (RS)**. Это кошелек который принимает участие в операциях ввода/вывода денег в/из системы. Это единственный аккаунт который владеет и дебетными и кредитными активами. Условием целосности системы является равность дебетных и кредитных денег на акакунте **RS**.
При запуске сервиса, **RS** имеет необходимое оборотное количество дебетных и кредетных активов.
Для выпуска и сервисных средств используется кошельки для **CORE** акканута, где на **CORE_MAIN** хранятся кредитные деньги, которые принимают участие в операциях обмена с пользователем, а на **CORE_SERVICE** хранятся деньги, которые гарантируют наличие средств для вывода.
На старте к-ство на кошельках **CORE_MAIN** и **CORE_SERVICE** равно.


### Для работы сервиса необходимо указать переменные среды:

- IS_STELLAR_TEST_NETWORK *{boolean}* **true** - для тестовой сети, **false** - для публичной сети или вместо этой переменной указать STELLAR_PASSPHRASE в случае если при конфиге Stellar network была указана не дефолтная *passphrase*
- STELLAR_URI *{string}* **https://horizon-testnet.stellar.org** - URI Horizon сервера.
- ROOT_SEED *{string}* **SCFSMAQNQRDYX6JUGYSGZQM4G5OKRH3CCRVUFB23T5XA6CR5ZDMXZFFU** - приватный ключ root аккаунта сети
- INIT_XLM_AMT *{number}* **100** - стартовый баланс люменов (XLM) при создании нового кошелька

### При первом запуске сервиса необходимо инициализировать системные записи при помощи некскольких комманд:
#### > Инициализация основных аккаунтов RS и ROOT:
При инициализации используются следующие переменные:
```
const assetsToRSObj = { DIMO: 10000 , TNZS: 10000 };
const fundAmtRS = 100000; // Initial balance
```
`assetsToRSObj` - Список названий Asset и их баланс для **резервного фонда (RS)** которые будут участывать в системе

`fundAmtRS` - стартовый баланс люменов (XLM) для **резервного фонда (RS)**, используется для оплаты комиссии операций.

Запустить в консоле:
`npm run init-stellar`

#### > Инициализация основных аккаунтов CORE:
При инициализации используются следующие переменные:
```
const assetsToRSObj = { DIMO: 100000, TNZS: 100000 };
const fundAmtRS = 100000; // Initial balance
```
`assetsCoreObj` - Список названий Asset и их баланс для **CORE аккаунтов** которые будут участывать в системе

`fundAmt` - стартовый баланс люменов (XLM) для **CORE аккаунтов**, используется для оплаты комиссии операций.

Запустить в консоле:
`npm run init-core`

#### > Инициализация основных каналов оплаты:
Каналы оплаты сделаны для увеличения пропускной спосовности подписания транзакций общими аккаунтами

При инициализации используются следующие переменные:'

```
const endPointArray = [CHANNELS_ROUTER.DEPOSIT, CHANNELS_ROUTER.WITHDRAW, CHANNELS_ROUTER.EXCHANGE];
const startBalance = 10000;
countUp: number = 5

```
`endPointArray` - Масив констант обозначающие методы для которых будет использоваться для разделения (роутинга) в зависимости от метода

`startBalance` - стартовый баланс люменов (XLM) для аккаунтов канала, используется для оплаты комиссии операций.

`countUp` - количество акканутов в одном роутере

Визуально каждый аккаунт системы имеет следующую структуру:

```
RS_MAIN {
  base: {
    address: "",
    secret: "",
  }
  pending: {
    address: "",
    secret: "",
  }
  channels: {
    DEPOSIT: [
      {
        address: "",
        secret: "",
      },
      {
        address: "",
        secret: "",
      },
      ...
    ],
    WITHDRAW: [
      {
        address: "",
        secret: "",
      },
      {
        address: "",
        secret: "",
      },
      ...
    ],
    ...
  }
}
```

Запустить в консоле:
`npm run init-channels`

## Тестирование
#### После инициализации приложения

По дефолту использует *`.env.test`*

- *`npm run test-unit`* Запуск юнит тестов.
- *`npm run test-e2e`* Запуск API и Service тестов.
- *`npm run test-all`* Запуск всех тестов.
- *`npm run test-coverage`* Запуск всех тестов в режиме coverage.

## Запуск приложения
#### После инициализации приложения
- *`npm run dev`* Запуск приложения в режиме разработки.
- *`npm run build`* Сборка приложения в прдакшн версию
- *`npm run start`*  Запуск всех тестов в режиме продакшн.

## Keys storage
#### Для хранения приватных ключей кошельков клиентов используем Vault сервер от Hashicorp.
#### https://learn.hashicorp.com/vault/
#### Для корректной работы сервиса в связке с хранилищем Vault необходимо в файле `.env` указать следующие переменные среды:
- VAULT_URL - адрес Vault сервера (http://127.0.0.1:8200)
- VAULT_TOKEN - токен пользователя с полными правами к папке `/secret/stellarKeys/`

### Небольшая инструкция по деплою тестового Vault сервера:
- Скачиваем бинарник и ложим в папку *`/usr/bin`*
- Выполняем *`/usr/bin/vault -autocomplete-install`* и перезапускаем терминал.
- Запускаем сервер с конфигом *`sudo vault server -config=config.hcl`*
```
$> cat config.hcl
backend "file" {
  path = "vault"
}

listener "tcp" {
  address = "127.0.0.1:8200"
  tls_disable = 1
}
```
- Открываем второй терминал и устанавливаем переменную среды *`export VAULT_ADDR=http://127.0.0.1:8200`*
- Инициализируем сервер *`vault operator init`* и сохраняем полученые ключи для разблокировки сервера
- Для разблокировки сервера необходимо 3 раза ввести 3 разных ключа оператора при выполнении *`vault operator unseal`*.
- После успешной разблокировки сервера устанавливаем бэкенд *`kv`* для папки *`/secret`* - *`vault secrets enable -path=/secret kv`*
- для большей безопасности необходимо создать токен для пользователя с настроенными *`policy`* для папки *`/secret/stellarKeys/`*
