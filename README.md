## Stellar Private Network microservice

[![Build Status](https://travis-ci.com/mkaliberda/StellarApi.svg?token=6bfZmbby9wfWj9uzzAgb&branch=dev)](https://travis-ci.com/mkaliberda/StellarApi)

**Микросервис для менеджмента баллансов кошельков пользователей финансовой системы DIMO.**

Архитектура сервиса представляет собой дебитно/кредитную систему хранения балансов.
Кредитые балансы отражают денежные обязательства перед клиентами (балансы которыми владеют пользователь), а дебитные - обязательства внешних сервисов перед владельцами системы или собственных активов владельцев системы.
При этом существует такое понятие как **резервный фонд (RS)**. Это кошелек который принимает участие в операциях ввода/вывода денег в/из системы. Это единственный аккаунт который владеет и дебетными и кредитными активами. Условием целосности системы является равность дебетных и кредитных денег на акакунте **RS**.
При запуске сервиса, **RS** имеет необходимое оборотное количество дебетных и кредетных активов.

### При первом запуске сервиса необходимо инициализировать системные аккаунты в сети командой:
`npm run init-stellar`

Для работы сервиса необходимо указать переменные среды:

- IS_STELLAR_TEST_NETWORK *{boolean}* **true** - для тестовой сети, **false** - для публичной сети или вместо этой переменной указать STELLAR_PASSPHRASE в случае если при конфиге Stellar network была указана не дефолтная *passphrase*
- STELLAR_URI *{string}* **https://horizon-testnet.stellar.org** - URI Horizon сервера.
- ROOT_SEED *{string}* **SCFSMAQNQRDYX6JUGYSGZQM4G5OKRH3CCRVUFB23T5XA6CR5ZDMXZFFU** - приватный ключ root аккаунта сети
- INIT_XLM_AMT *{number}* **100** - стартовый баланс люменов (XLM) при создании нового кошелька


## Keys storage
#### Для хранения приватных ключей кошельков клиентов используем Vault сервер от Hashicorp.
#### https://learn.hashicorp.com/vault/
#### Для корректной работы сервиса в связке с хранилищем Vault необходимо в файле `.env` указать следующие переменные среды:
- VAULT_URL - адрес Vault сервера (http://127.0.0.1:8200)
- VAULT_TOKEN - токен пользователя с полными правами к папке `/secret/stellarKeys/`

### Небольшая инструкция по деплою тестового Vault сервера:
- Скачиваем бинарник и ложим в папку *`/usr/bin`*
- Выполняем *`/usr/bin/vault -autocomplete-install`* и перезапускаем терминал.
- Запускаем сервер с конфигом *`sudo vault server -config=config.hcl`*
```
$> cat config.hcl
backend "file" {
  path = "vault"
}

listener "tcp" {
  address = "127.0.0.1:8200"
  tls_disable = 1
}
```
- Открываем второй терминал и устанавливаем переменную среды *`export VAULT_ADDR=http://127.0.0.1:8200`*
- Инициализируем сервер *`vault operator init`* и сохраняем полученые ключи для разблокировки сервера
- Для разблокировки сервера необходимо 3 раза ввести 3 разных ключа оператора при выполнении *`vault operator unseal`*.
- После успешной разблокировки сервера устанавливаем бэкенд *`kv`* для папки *`/secret`* - *`vault secrets enable -path=/secret kv`*
- для большей безопасности необходимо создать токен для пользователя с настроенными *`policy`* для папки *`/secret/stellarKeys/`*
